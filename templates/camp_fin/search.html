{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
Search
{% endblock %}

{% block full_content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <form method='GET'>
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control" placeholder="Search for candidates, committees and donors in New Mexico" id="term" name="term" {% if term %}value="{{term}}"{% endif %}>
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="submit"><i class='fa fa-search'></i> Search</button>
                    </span>
                </div>
                <div class="form-group" id='filter-results'>
                    <br />
                    <div class="row">
                        <div class="col-md-2">
                            <span>Search for</span>
                        </div>
                        <div class="col-md-10">
                            <label data-title='Candidates' data-content='Any person who seeks nomination for election, election to, or retention in public office'>
                                <input type="checkbox" name="table_name" value="candidate" {% if 'candidate' in table_name %}checked='checked'{% endif %}> Candidates
                            </label>
                            <label data-title='Committees' data-content='Includes committees for political candidates, political parties, political action committees (PACs), and ballot initiatives'>
                                <input type="checkbox" name="table_name" value="pac" {% if 'pac' in table_name %}checked='checked'{% endif %}> Committees
                            </label>
                            <label data-title='Donations' data-content='Any person or organization who has given to a political committee'>
                                <input type="checkbox" name="table_name" value="contribution" {% if 'contribution' in table_name %}checked='checked'{% endif %}> Donations to committees
                            </label>
                            <label data-title='Expenditures' data-content='Any person or organization who was given money by a political committee'>
                                <input type="checkbox" name="table_name" value="expenditure" {% if 'expenditure' in table_name %}checked='checked'{% endif %}> Expenditures by committees
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div id="search-results" class="col-md-12"></div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/URI.min.js' %}"></script>
<script src="{% static 'js/ejs_production.js' %}"></script>
<script src="{% static 'js/accounting.min.js' %}"></script>
<script src="{% static 'js/moment.min.js' %}"></script>
<script type="text/EJS" id="contribution-template">
    <h3>Contributions</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Donor</th>
                <th>Recipient</th>
                <th class="text-right nowrap">Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <% $.each(rows, function(i, row){ %>
                <tr>
                    <td>
                        <a href="/search/?term=<%= row.full_name %>">
                            <%= row.full_name %>
                        </a>
                    </td>
                    <td>
                        <% if (row.pac_slug){ %>
                            <a href="/committees/<%= row.pac_slug %>/">
                                <%= row.transaction_subject %>
                            </a>
                        <% } else { %>
                            <a href="/candidates/<%= row.candidate_slug %>/">
                                <%= row.transaction_subject %>
                        <% } %>
                    </td>
                    <td>
                        <%= accounting.formatMoney(row.amount) %>
                    </td>
                    <td>
                        <%= moment(row.received_date).format('MMMM DD, YYYY') %>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</script>
<script type="text/EJS" id="pac-template">
    <h3>Committees</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
            </tr>
        </thead>
        <tbody>
            <% $.each(rows, function(i, row){ %>
                <tr>
                    <td>
                        <a href="/committees/<%= row.slug %>/">
                            <%= row.name %>
                        </a>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</script>
<script type="text/EJS" id="candidate-template">
    <h3>Candidates</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
            </tr>
        </thead>
        <tbody>
            <% $.each(rows, function(i, row){ %>
                <tr>
                    <td>
                        <a href="/candidates/<%= row.slug %>/">
                            <%= row.prefix %> <%= row.first_name %> <%= row.middle_name %><%= row.last_name %><%= row.suffix %>
                        </a>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</script>
<script type="text/EJS" id="expenditure-template">
    <h3>Expenditures</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Recipient</th>
                <th>Spender</th>
                <th class="text-right nowrap">Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <% $.each(rows, function(i, row){ %>
                <tr>
                    <td>
                        <a href="/search/?term=<%= row.full_name %>">
                            <%= row.full_name %>
                        </a>
                    </td>
                    <td>
                        <% if (row.pac_slug){ %>
                            <a href="/committees/<%= row.pac_slug %>/">
                                <%= row.transaction_subject %>
                            </a>
                        <% } else { %>
                            <a href="/candidates/<%= row.candidate_slug %>/">
                                <%= row.transaction_subject %>
                        <% } %>
                    </td>
                    <td>
                        <%= accounting.formatMoney(row.amount) %>
                    </td>
                    <td>
                        <%= moment(row.received_date).format('MMMM DD, YYYY') %>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</script>
<script type="text/javascript">
    function do_query(term){
        $.when($.getJSON('/api/search/', term)).then(
            function(data){
                $.each(data, function(table, rows){
                    if(rows.length > 0){
                        var template = new EJS({'text': $('#' + table + '-template').html()});
                        $('#search-results').append(template.render({'rows': rows}));
                    }
                })
            }
        )
    }
    $(document).ready(function(){
        {% if term != None %}
            var query = URI(window.location.search).query(true)
            do_query(query);
        {% endif %}
    })

</script>
{% endblock %}

